<app-navbar></app-navbar>

<div class="container mt-4 chat-container shadow rounded overflow-hidden bg-white">
    <div class="row h-100 g-0">
        
        <div class="col-md-4 border-end chat-list-col">
            <div class="p-3 bg-light border-bottom">
                <h5 class="mb-0">Mis Mensajes</h5>
            </div>
            
            <div class="list-group list-group-flush overflow-auto" style="height: 500px;">
                <button *ngFor="let c of conversations" 
                        class="list-group-item list-group-item-action d-flex align-items-center p-3"
                        [class.active]="selectedConversation?.idConversation === c.idConversation"
                        (click)="selectChat(c)">
                    
                    <img [src]="getImageUrl(c.otherUserProfileImage)" class="rounded-circle me-3" width="50" height="50">
                    
                    <div class="flex-grow-1 overflow-hidden">
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-truncate" [class.fw-bold]="c.unreadCount > 0">
                                {{c.otherUserName}}
                            </h6>
                            
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-2" style="font-size: 0.7rem;">
                                    {{c.lastMessageAt | date:'shortTime'}}
                                </small>
                                <span *ngIf="c.unreadCount > 0" class="badge bg-success rounded-pill" style="font-size: 0.65rem;">
                                    {{c.unreadCount}}
                                </span>
                            </div>
                        </div>

                        <small class="text-muted d-block text-truncate mt-1">
                            <i class="bi bi-tag-fill me-1"></i> {{c.productName}}
                        </small>
                    </div>
                </button>

                <div *ngIf="conversations.length === 0" class="p-4 text-center text-muted">
                    No tienes conversaciones.
                </div>
            </div>
        </div>

        <div class="col-md-8 d-flex flex-column chat-area">
            
            <div class="p-3 border-bottom d-flex align-items-center bg-white shadow-sm" style="z-index: 10;" *ngIf="selectedConversation">
                <h6 class="mb-0">
                    Conversando con <strong>{{selectedConversation.otherUserName}}</strong> 
                    sobre <span class="badge bg-secondary">{{selectedConversation.productName}}</span>
                </h6>
            </div>

            <div class="flex-grow-1 p-4 overflow-auto bg-light" *ngIf="selectedConversation; else noChat">
                <div *ngFor="let m of messages" class="mb-3 d-flex"
                     [ngClass]="{'justify-content-end': m.idSender !== selectedConversation.otherUserId}">
                    
                    <div class="card border-0 shadow-sm" 
                         [ngClass]="{'bg-primary text-white': m.idSender !== selectedConversation.otherUserId, 'bg-white text-dark': m.idSender === selectedConversation.otherUserId}"
                         style="max-width: 75%; border-radius: 15px;">
                        <div class="card-body py-2 px-3">
                            <p class="mb-1">{{m.content}}</p>
                            <div class="d-flex justify-content-end align-items-center">
                                <small class="opacity-75" style="font-size: 0.65rem;">
                                    {{m.createdAt | date:'shortTime'}}
                                </small>
                                <i *ngIf="m.idSender !== selectedConversation.otherUserId" 
                                   class="bi bi-check-all ms-1" 
                                   [ngClass]="{'text-info': m.isRead, 'text-white-50': !m.isRead}"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-3 border-top bg-white" *ngIf="selectedConversation">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Escribe un mensaje..." 
                           [(ngModel)]="newMessage" (keyup.enter)="send()">
                    <button class="btn btn-primary" (click)="send()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>

            <ng-template #noChat>
                <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted">
                    <i class="bi bi-chat-dots display-1 mb-3"></i>
                    <p>Selecciona una conversaci√≥n para empezar.</p>
                </div>
            </ng-template>

        </div>
    </div>
</div>